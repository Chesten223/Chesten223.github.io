<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Access Terminal | 2026 Cyber Gift</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Noto+Serif+SC:wght@300;600&family=Space+Mono&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* ================= 0. å…¨å±€æ ·å¼ ================= */
        :root {
            --bg-dark: #050505;
            --gold-primary: #D4AF37;
            --font-title: 'Cinzel', serif;
            --font-body: 'Noto Serif SC', serif;
            --font-tech: 'Space Mono', monospace;
            --error-red: #ff4d4d;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: var(--bg-dark);
            color: #e0e0e0;
            font-family: var(--font-tech);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }

        .ambient-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: radial-gradient(circle at 50% 50%, rgba(212, 175, 55, 0.05), transparent 70%);
        }

        /* è¯­è¨€åˆ‡æ¢å™¨ (å³ä¸Šè§’) */
        .lang-switch-container {
            position: absolute; top: 20px; right: 20px; z-index: 100;
            display: flex; gap: 10px;
        }
        .lang-btn {
            background: rgba(0,0,0,0.6); border: 1px solid #444; color: #888;
            padding: 5px 10px; font-size: 0.7rem; font-family: var(--font-tech);
            cursor: pointer; border-radius: 4px; transition: 0.3s;
        }
        .lang-btn.active {
            border-color: var(--gold-primary); color: var(--gold-primary);
            background: rgba(212, 175, 55, 0.1);
        }

        /* ================= æ–°å¸ƒå±€å®¹å™¨ ================= */
        .studio-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 40px;
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            flex: 1;
            padding-top: 5vh;
            transition: all 0.5s ease;
        }

        .console-column { flex: 0 1 450px; width: 100%; transition: all 0.5s ease; }

        .preview-column {
            flex: 0 1 400px; width: 100%;
            display: none; flex-direction: column; align-items: center;
            opacity: 0; transform: translateX(20px);
            transition: opacity 0.6s ease, transform 0.6s ease;
        }
        .preview-column.active { display: flex; }
        .preview-column.visible { opacity: 1; transform: translateX(0); }

        @media (max-width: 900px) {
            .studio-container { flex-direction: column; align-items: center; padding-top: 50px; gap: 20px; }
            .preview-column { order: -1; max-width: 320px; display: none !important; }
            .preview-column.active { display: flex !important; margin-bottom: 20px; }
        }

        /* ================= æ§åˆ¶å°å¡ç‰‡ ================= */
        .console-card {
            background: rgba(20, 20, 20, 0.95);
            border: 1px solid rgba(212, 175, 55, 0.3);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.9);
            position: relative; z-index: 10;
        }

        .console-header { text-align: center; color: var(--gold-primary); font-family: var(--font-title); font-size: 1.5rem; letter-spacing: 2px; margin-bottom: 5px; }
        .console-sub { text-align: center; font-size: 0.6rem; color: #666; letter-spacing: 2px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 25px; }

        .input-group { margin-bottom: 18px; position: relative; }
        .input-label { display: block; font-size: 0.6rem; color: var(--gold-primary); margin-bottom: 5px; letter-spacing: 1px; font-weight: bold; }
        .input-label.optional::after { content: attr(data-opt); color: #666; font-size: 0.5rem; font-weight: normal; margin-left: 5px; }
        
        .input-helper { font-size: 0.55rem; color: #888; margin-top: 4px; font-style: italic; line-height: 1.4; }
        .input-helper span { color: #aaa; }

        .access-input {
            width: 100%; background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1);
            color: #fff; padding: 12px; font-family: var(--font-tech); text-align: left; font-size: 0.9rem;
            border-radius: 4px; outline: none; transition: 0.3s;
        }
        .access-input:focus { border-color: var(--gold-primary); box-shadow: 0 0 10px rgba(212, 175, 55, 0.2); }
        textarea.access-input { resize: none; height: 80px; font-family: var(--font-body); }

        .verify-btn {
            width: 100%; padding: 14px; background: var(--gold-primary); border: none; border-radius: 4px;
            color: #000; font-family: var(--font-tech); font-weight: bold; cursor: pointer; letter-spacing: 1px;
            transition: 0.3s; margin-top: 10px; display: flex; justify-content: center; align-items: center;
        }
        .verify-btn:hover:not(:disabled) { background: #F9E79F; box-shadow: 0 0 20px rgba(212, 175, 55, 0.4); }
        .verify-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .secondary-btn { background: transparent; border: 1px solid #555; color: #aaa; margin-top: 10px; }
        .secondary-btn:hover { border-color: #888; color: #fff; background: rgba(255,255,255,0.05); }

        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.6s forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* é£æ ¼é€‰æ‹© & å¡ç‰‡è¯­è¨€åˆ‡æ¢ */
        .gift-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .gift-option {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            padding: 10px; text-align: center; cursor: pointer; border-radius: 6px; transition: 0.3s;
        }
        .gift-option:hover { background: rgba(255,255,255,0.1); }
        .gift-option.selected {
            border-color: var(--gold-primary); background: rgba(212, 175, 55, 0.1);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.2);
        }
        .gift-icon { font-size: 1.2rem; display: block; margin-bottom: 2px; }
        .gift-name { font-size: 0.6rem; color: #aaa; }
        .gift-option.selected .gift-name { color: var(--gold-primary); }

        /* è¿·ä½ åˆ‡æ¢å™¨ (ç”¨äºå¡ç‰‡è¯­è¨€) */
        .card-lang-toggle {
            display: flex; background: rgba(0,0,0,0.3); border-radius: 4px; padding: 2px;
            width: fit-content; border: 1px solid #333; margin-bottom: 15px;
        }
        .cl-btn {
            padding: 4px 10px; font-size: 0.6rem; cursor: pointer; color: #666; border-radius: 2px;
        }
        .cl-btn.active { background: #333; color: var(--gold-primary); }

        /* ç»“æœåŒºåŸŸ */
        #result-area { margin-top: 20px; border-top: 1px dashed #333; padding-top: 20px; }
        .link-box {
            background: #000; border: 1px solid #333; padding: 10px; font-size: 0.6rem; color: var(--gold-primary);
            word-break: break-all; margin-bottom: 15px; font-family: monospace; text-align: center;
        }

        /* ================= 4. é¢„è§ˆå¡ç‰‡ ================= */
        .preview-label {
            color: var(--gold-primary); font-family: var(--font-tech); font-size: 0.7rem; 
            margin-bottom: 10px; letter-spacing: 2px; text-align: center; width: 100%;
        }

        #preview-card {
            position: relative; width: 100%; aspect-ratio: 9/16; background-color: #000;
            border: 1px solid #333; margin: 0 auto; border-radius: 4px; overflow: hidden;
            display: flex; flex-direction: column; justify-content: space-between;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .dynamic-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .bg-mask {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.35); z-index: 2; pointer-events: none;
        }

        .card-content { position: relative; z-index: 5; height: 100%; display: flex; flex-direction: column; justify-content: space-between; padding: 25px; }
        
        .card-frame {
            position: absolute; top: 12px; left: 12px; right: 12px; bottom: 12px;
            border: 1px solid rgba(212, 175, 55, 0.3); pointer-events: none; z-index: 6;
        }
        .card-frame::before {
            content: ''; position: absolute; top: -1px; left: 50%; transform: translateX(-50%);
            width: 60px; height: 2px; background: #000;
        }

        .c-header { text-align: center; margin-top: 10px; }
        .c-title { font-family: var(--font-title); color: var(--gold-primary); font-size: 1.4rem; font-weight: bold; text-shadow: 0 0 10px rgba(0,0,0,0.8); }
        .c-sub { font-family: var(--font-tech); color: #ccc; font-size: 0.6rem; letter-spacing: 2px; }

        .c-body { text-align: center; flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 15px; }
        .c-to { font-family: var(--font-tech); font-size: 0.8rem; color: var(--gold-primary); letter-spacing: 1px; width: 100%; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; }
        .c-wish { font-family: var(--font-body); color: #fff; font-size: 1.1rem; line-height: 1.6; text-shadow: 0 2px 5px #000; width: 100%; font-style: italic; white-space: pre-wrap; word-break: break-word; }
        .c-from { font-family: var(--font-tech); font-size: 0.7rem; color: #ccc; align-self: flex-end; letter-spacing: 1px; }

        .c-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 5px; padding: 0 2px; }
        .c-qr { background: #000; border: 1px solid var(--gold-primary); padding: 3px; width: 60px; height: 60px; display:flex; justify-content:center; align-items:center; }
        .c-qr-placeholder { color: #333; font-size: 0.5rem; text-align: center; } 
        .c-meta { text-align: right; font-size: 0.45rem; color: #666; font-family: var(--font-tech); line-height: 1.4; letter-spacing: 0.5px; }
        .c-meta span.highlight { color: var(--gold-primary); }

        .save-btn {
            background: transparent; border: 1px solid var(--gold-primary); color: var(--gold-primary);
            width: 100%; padding: 10px; margin-top: 15px; font-family: var(--font-tech); cursor: pointer; transition: 0.3s;
        }
        .save-btn:hover { background: var(--gold-primary); color: #000; }

        .text-error { color: var(--error-red) !important; border-color: var(--error-red) !important; }
        .shake { animation: shake 0.4s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .loader { width: 12px; height: 12px; border: 2px solid #000; border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; margin-right: 5px; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* éšè—çš„é«˜æ¸…æ¸²æŸ“èˆå° */
        #render-stage-wrapper { position: absolute; width: 0; height: 0; overflow: hidden; z-index: -999; }
        #hd-render-card { width: 450px; height: 800px; position: relative; background: #000; display: flex; flex-direction: column; justify-content: space-between; }
    </style>
</head>
<body>

    <div class="ambient-bg"></div>

    <div class="lang-switch-container">
        <div class="lang-btn active" onclick="setUILang('zh')" id="lang-btn-zh">CN</div>
        <div class="lang-btn" onclick="setUILang('en')" id="lang-btn-en">EN</div>
    </div>

    <div class="studio-container">
        <div class="console-column">
            <div class="console-card">
                <div class="console-header">CYBER GIFT 2026</div>
                <div class="console-sub" data-i18n="subtitle">SECURE GIFT TERMINAL</div>

                <div id="step1">
                    <div class="input-group">
                        <input type="text" id="keyCode" class="access-input" style="text-align:center;" placeholder="è¾“å…¥å…‘æ¢ç  / ENTER REDEEM CODE" autocomplete="off" data-i18n-placeholder="code_placeholder">
                    </div>
                    <button class="verify-btn" onclick="verifyCode()">
                        <span id="btn1Text" data-i18n="verify_btn">éªŒè¯ä»£ç  / VERIFY CODE</span>
                    </button>
                </div>

                <div id="step2" class="hidden">
                    
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <div style="font-size:0.6rem; color:#888;" data-i18n="select_style">é€‰æ‹©è§†è§‰åè®® / SELECT VISUAL PROTOCOL</div>
                    </div>

                    <div class="gift-grid">
                        <div class="gift-option selected" onclick="selectType('stars')">
                            <span class="gift-icon">ğŸŒŒ</span><span class="gift-name" data-i18n="style_stars">æ˜Ÿæ²³</span>
                        </div>
                        <div class="gift-option" onclick="selectType('love')">
                            <span class="gift-icon">â¤ï¸</span><span class="gift-name" data-i18n="style_love">æ‹æ­Œ</span>
                        </div>
                        <div class="gift-option" onclick="selectType('firework')">
                            <span class="gift-icon">ğŸ†</span><span class="gift-name" data-i18n="style_fire">èŠ±ç«</span>
                        </div>
                        <div class="gift-option" onclick="selectType('portal')">
                            <span class="gift-icon">ğŸ”¯</span><span class="gift-name" data-i18n="style_portal">æ³•é˜µ</span>
                        </div>
                    </div>

                    <div class="input-group">
                         <span class="input-label" data-i18n="card_lang_label">å¡ç‰‡æ˜¾ç¤ºè¯­è¨€ / CARD DISPLAY LANGUAGE</span>
                         <div class="card-lang-toggle">
                             <div class="cl-btn active" id="cl-en" onclick="setCardLang('en')">ENGLISH</div>
                             <div class="cl-btn" id="cl-zh" onclick="setCardLang('zh')">ä¸­æ–‡ (CHINESE)</div>
                         </div>
                    </div>

                    <div class="input-group">
                        <span class="input-label optional" data-i18n="label_to" data-opt="(é€‰å¡«)">æ¥æ”¶è€… / TO</span>
                        <input type="text" id="inputTo" class="access-input" placeholder="Name" maxlength="20" data-i18n-placeholder="placeholder_name">
                    </div>

                    <div class="input-group">
                        <span class="input-label" data-i18n="label_card_text">è´ºå¡çŸ­è¯­ (å›¾ç‰‡ä¸Š) / CARD TEXT</span>
                        <textarea id="inputCardText" class="access-input" rows="3" placeholder="e.g. Happy New Year" maxlength="50" data-i18n-placeholder="placeholder_card_text" style="height:auto; min-height:60px;"></textarea>
                        <div class="input-helper">
                            <span data-i18n="helper_card_text_1">* æ¯ä¸€è¡Œä¼šè‡ªåŠ¨åŠ ä¸Šå¼•å·ã€‚</span><br>
                            <span data-i18n="helper_card_text_2">* æœ€å¤š3è¡Œï¼Œæ€»å­—æ•°é™åˆ¶50å­—ã€‚</span>
                        </div>
                    </div>

                    <div class="input-group">
                        <span class="input-label" data-i18n="label_qr_msg">éšè—ç¥ç¦ (äºŒç»´ç å†…) / SECRET MESSAGE</span>
                        <textarea id="inputWish" class="access-input" placeholder="Write your long secret message here..." maxlength="200" data-i18n-placeholder="placeholder_wish"></textarea>
                        <div class="input-helper">
                            <span data-i18n="helper_qr_msg_1">* æ­¤ä¿¡æ¯éšè—åœ¨äºŒç»´ç ä¸­ã€‚</span><br>
                            <span data-i18n="helper_qr_msg_2">* å¯¹æ–¹æ‰«ç åæ‰èƒ½çœ‹åˆ°ã€‚</span>
                        </div>
                    </div>

                    <div class="input-group">
                        <span class="input-label optional" data-i18n="label_from" data-opt="(é€‰å¡«)">å‘é€è€… / FROM</span>
                        <input type="text" id="inputFrom" class="access-input" placeholder="Your Name" maxlength="20" data-i18n-placeholder="placeholder_your_name">
                    </div>

                    <button class="verify-btn" onclick="finalizeGift()">
                        <span id="btn2Text" data-i18n="btn_generate">ç”Ÿæˆç¤¼ç‰© / GENERATE GIFT</span>
                    </button>
                </div>

                <div id="result-area" class="hidden">
                    <div style="text-align:center; color:var(--gold-primary); margin-bottom:5px;" data-i18n="msg_generated">GIFT GENERATED</div>
                    <div class="link-box" id="finalLink">Processing...</div>
                    
                    <div style="text-align:center; font-size:0.6rem; color:#888; margin-bottom:15px; line-height:1.4;">
                        <span style="color:var(--error-red);" data-i18n="tip_save_safely">âš ï¸ è¯·åŠ¡å¿…ä¿å­˜å¥½æ‚¨çš„å›¾ç‰‡ä¸é“¾æ¥ï¼Œè¿™æ˜¯è®¿é—®æ‚¨çš„ç¤¼ç‰©çš„å”¯ä¸€é€”å¾„ã€‚å¤±å»åˆ™æ— æ³•æ‰¾å›ã€‚</span>
                    </div>
                    
                    <button class="save-btn" onclick="downloadImage()" data-i18n="btn_download">â¬‡ ä¿å­˜å¡ç‰‡å›¾ç‰‡ / SAVE CARD IMAGE</button>
                    <button class="verify-btn secondary-btn" onclick="location.reload()" data-i18n="btn_restart">â†º å†å…‘æ¢ä¸€ä¸ª / REDEEM ANOTHER</button>
                </div>
            </div>
        </div>

        <div class="preview-column" id="previewColumn">
            <div class="preview-label" data-i18n="preview_title">/// å®æ—¶é¢„è§ˆ REAL-TIME PREVIEW ///</div>
            
            <div id="preview-card">
                <canvas id="preview-canvas" class="dynamic-canvas"></canvas>
                <div class="bg-mask"></div>
                <div class="card-frame"></div>
                
                <div class="card-content">
                    <div class="c-header">
                        <div class="c-title">CYBER GIFT</div>
                        <div class="c-sub">2026 EDITION</div>
                    </div>
                    
                    <div class="c-body">
                        <div class="c-to" id="cardTo">TO: -</div>
                        <div class="c-wish" id="cardTextDisplay">Happy New Year</div>
                        <div class="c-from" id="cardFrom">FROM: -</div>
                    </div>

                    <div class="c-footer">
                        <div class="c-qr" id="qrcode">
                            <div class="c-qr-placeholder">[QR]</div>
                        </div>
                        <div class="c-meta">
                            <span id="cardId">ID: PENDING</span><br>
                            <span class="highlight" data-i18n="preview_mode_text">PREVIEW MODE</span><br>
                            <span id="cardDate">...</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="input-helper" style="text-align:center; margin-top:10px;" data-i18n="preview_hint">
                äºŒç»´ç å°†åœ¨æœ€åä¸€æ­¥ç”Ÿæˆã€‚
            </div>
        </div>
    </div>

    <div id="render-stage-wrapper">
        <div id="hd-render-card" style="width: 400px; height: 711px; position: relative; background: #000; display: flex; flex-direction: column; justify-content: space-between; overflow: hidden;">
            <canvas id="hd-canvas" style="position:absolute; top:0; left:0; z-index:0;"></canvas>
            <div class="bg-mask"></div>
            <div class="card-frame" style="top:15px; left:15px; right:15px; bottom:15px;"></div>
            
            <div class="card-content" style="padding:25px; height:100%; display:flex; flex-direction:column; justify-content:space-between; position:relative; z-index:5;">
                <div class="c-header" style="margin-top:10px;">
                    <div class="c-title" style="font-size:1.6rem;">CYBER GIFT</div>
                    <div class="c-sub" style="font-size:0.7rem;">2026 EDITION</div>
                </div>
                
                <div class="c-body" style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; gap:15px;">
                    <div class="c-to" id="hd-cardTo" style="font-size:0.9rem; width:100%; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:5px;">TO: -</div>
                    
                    <div class="c-wish" id="hd-cardWish" style="font-size:1.2rem; line-height:1.6; width:100%; font-style:italic; white-space: pre-wrap; word-break: break-word;">-</div>
                    
                    <div class="c-from" id="hd-cardFrom" style="font-size:0.8rem; align-self:flex-end;">FROM: -</div>
                </div>

                <div class="c-footer" style="display:flex; justify-content:space-between; align-items:flex-end;">
                    <div class="c-qr" id="hd-qrcode" style="width:86px; height:86px; padding:8px; background:#000; border:1px solid #D4AF37; display:flex; justify-content:center; align-items:center;"></div>
                    <div class="c-meta" style="font-size:0.55rem; text-align:right; line-height:1.4;">
                        <span id="hd-cardId">ID: ....</span><br>
                        <span class="highlight">VERIFIED</span><br>
                        <span id="hd-cardDate">MINTED: ...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ================= é…ç½® =================
        const API_BASE = "https://vimalin.xyz:8443/api";
        const GIFT_URLS = {
            'stars': "https://cybergift.store/stars/",
            'firework': "https://cybergift.store/firework/",
            'love': "https://cybergift.store/love/",
            'portal': "https://cybergift.store/magicframe/"
        };
        
        // ================= è¯­è¨€åŒ… =================
        const i18n = {
            zh: {
                // title: "èµ›åšè´ºå¡ 2026",  <-- è¿™è¡Œæˆ‘åˆ æ‰äº†ï¼Œå› ä¸ºæ ‡é¢˜ä¸ç”¨ç¿»è¯‘äº† 
                subtitle: "å®‰å…¨ç¤¼å“ç»ˆç«¯",
                code_placeholder: "è¾“å…¥å…‘æ¢ç ",
                verify_btn: "éªŒè¯ä»£ç ",
                select_style: "é€‰æ‹©è§†è§‰åè®®",
                style_stars: "æ˜Ÿæ²³",
                style_love: "æ‹æ­Œ",
                style_fire: "èŠ±ç«",
                style_portal: "æ³•é˜µ",
                card_lang_label: "è´ºå¡æ˜¾ç¤ºè¯­è¨€ (æ§åˆ¶å›¾ç‰‡æ–‡å­—)",
                label_to: "æ¥æ”¶è€… (TO)",
                label_from: "å‘é€è€… (FROM)",
                label_card_text: "è´ºå¡çŸ­è¯­ (å›¾ç‰‡ä¸Š)",
                helper_card_text_1: "* æ‰‹åŠ¨æ¢è¡Œå°†ä¸ºæ¯ä¸€è¡Œæ·»åŠ å¼•å·",
                helper_card_text_2: "* æœ€å¤šæ”¯æŒ 3 è¡Œï¼Œæ€»é™ 50 å­—",
                label_qr_msg: "éšå½¢ç¥ç¦ (äºŒç»´ç å†…)",
                helper_qr_msg_1: "* æ‰«ç åæ‰èƒ½çœ‹åˆ°çš„é•¿æ–‡æœ¬",
                helper_qr_msg_2: "* å¯å†™ä¸‹ä½ çš„å¿ƒé‡Œè¯",
                btn_generate: "ç”Ÿæˆç¤¼ç‰©",
                msg_generated: "ç¤¼ç‰©å·²ç”Ÿæˆ",
                btn_download: "â¬‡ ä¿å­˜å¡ç‰‡å›¾ç‰‡",
                btn_restart: "â†º å†å…‘æ¢ä¸€ä¸ª",
                preview_title: "/// å®æ—¶æ•ˆæœé¢„è§ˆ ///",
                preview_mode_text: "é¢„è§ˆæ¨¡å¼",
                verified_text: "å·²éªŒè¯",
                preview_hint: "äºŒç»´ç å°†åœ¨æœ€åä¸€æ­¥ç”Ÿæˆ",
                opt_text: "(é€‰å¡«)",
                // æ–°å¢çš„è¾“å…¥æ¡†æç¤ºè¯ 
                placeholder_name: "å¯¹æ–¹æ˜µç§°",
                placeholder_card_text: "ä¾‹å¦‚ï¼šæ–°å¹´å¿«ä¹",
                placeholder_wish: "åœ¨è¿™é‡Œå†™ä¸‹ä½ çš„ç§˜å¯†ç¥ç¦...",
                placeholder_your_name: "ä½ çš„ç½²å",
                // æ–°å¢
                tip_save_safely: "âš ï¸ è¯·åŠ¡å¿…ä¿å­˜å¥½æ‚¨çš„å›¾ç‰‡ä¸é“¾æ¥ï¼Œè¿™æ˜¯æ‰¾å›ç¤¼ç‰©çš„å”¯ä¸€å‡­è¯ã€‚",
                alert_copy_done: "âœ… é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\nå³å°†ä¸ºæ‚¨è‡ªåŠ¨ä¸‹è½½è´ºå¡å›¾ç‰‡ï¼Œè¯·æŸ¥æ”¶ã€‚",
                // å¡ç‰‡å†…éƒ¨æ–‡å­— (ZH)
                card_to: "è‡´",
                card_from: "è‡ª",
                card_minted: "é“¸é€ ",
                default_card_text: "æ–°å¹´å¿«ä¹"
            },
            en: {
                // title: "CYBER GIFT 2026", 
                subtitle: "SECURE GIFT TERMINAL",
                code_placeholder: "ENTER REDEEM CODE",
                verify_btn: "VERIFY CODE",
                select_style: "SELECT VISUAL PROTOCOL",
                style_stars: "STARS",
                style_love: "LOVE",
                style_fire: "FIRE",
                style_portal: "PORTAL",
                card_lang_label: "CARD DISPLAY LANGUAGE",
                label_to: "TO (RECIPIENT)",
                label_from: "FROM (SENDER)",
                label_card_text: "CARD TEXT (ON IMAGE)",
                helper_card_text_1: "* Manual new lines get quoted separately",
                helper_card_text_2: "* Max 3 lines, 50 chars limit",
                label_qr_msg: "DIGITAL MESSAGE (IN QR)",
                helper_qr_msg_1: "* Hidden inside the QR code",
                helper_qr_msg_2: "* Revealed after scanning",
                btn_generate: "GENERATE GIFT",
                msg_generated: "GIFT GENERATED",
                btn_download: "â¬‡ SAVE CARD IMAGE",
                btn_restart: "â†º REDEEM ANOTHER",
                preview_title: "/// REAL-TIME PREVIEW ///",
                preview_mode_text: "PREVIEW MODE",
                verified_text: "VERIFIED",
                preview_hint: "QR code generated at final step",
                opt_text: "(OPTIONAL)",
                // æ–°å¢çš„è¾“å…¥æ¡†æç¤ºè¯ 
                placeholder_name: "Name",
                placeholder_card_text: "e.g. Happy New Year",
                placeholder_wish: "Write your long secret message here...",
                placeholder_your_name: "Your Name",
                // æ–°å¢
                tip_save_safely: "âš ï¸ Please save your image and link safely. They are the only keys to access your gift.",
                alert_copy_done: "âœ… Link copied to clipboard!\n\nDownloading card image automatically...",
                // Card Internal Text (EN)
                card_to: "TO",
                card_from: "FROM",
                card_minted: "MINTED",
                default_card_text: "Happy New Year"
            }
        };

        let currentUILang = 'zh'; // é»˜è®¤UIä¸­æ–‡
        let currentCardLang = 'en'; // é»˜è®¤å¡ç‰‡è‹±æ–‡ (ä¸ºäº†é…·ç‚«)
        let currentCode = "";
        let selectedType = 'stars';

        // åˆå§‹åŒ–
        document.addEventListener("DOMContentLoaded", () => {
            const inputs = ['inputTo', 'inputFrom', 'inputCardText'];
            inputs.forEach(id => {
                document.getElementById(id).addEventListener('input', updateRealTimeUI);
            });
            
            // æ–°å¢ï¼šé™åˆ¶è´ºå¡çŸ­è¯­çš„è¡Œæ•° (æœ€å¤š3è¡Œ)
            document.getElementById('inputCardText').addEventListener('input', function() {
                const lines = this.value.split('\n');
                if (lines.length > 3) {
                    this.value = lines.slice(0, 3).join('\n');
                }
            });

            // åˆå§‹åŒ–è¯­è¨€
            setUILang('zh');
            updateRealTimeUI();
        });

        // --- è¯­è¨€åˆ‡æ¢é€»è¾‘ ---
        function setUILang(lang) {
            currentUILang = lang;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('lang-btn-zh').classList.toggle('active', lang === 'zh');
            document.getElementById('lang-btn-en').classList.toggle('active', lang === 'en');

            // æ›´æ–°æ‰€æœ‰æ–‡æœ¬å…ƒç´ 
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(i18n[lang][key]) el.innerText = i18n[lang][key];
            });

            // æ›´æ–° placeholder
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if(i18n[lang][key]) el.placeholder = i18n[lang][key];
            });
            
            // æ›´æ–°é€‰å¡«æç¤º (ä¼ªå…ƒç´ æ— æ³•ç›´æ¥æ”¹ï¼Œç”¨ data-attr ä»£ç†)
            const optText = i18n[lang]['opt_text'];
            document.querySelectorAll('.input-label.optional').forEach(el => {
                el.setAttribute('data-opt', optText);
            });
        }

        function setCardLang(lang) {
            currentCardLang = lang;
            document.getElementById('cl-zh').classList.toggle('active', lang === 'zh');
            document.getElementById('cl-en').classList.toggle('active', lang === 'en');
            updateRealTimeUI(); // ç«‹å³åˆ·æ–°é¢„è§ˆ
        }

        // --- Step 1: éªŒè¯ ---
        async function verifyCode() {
            const input = document.getElementById('keyCode');
            const btn = document.querySelector('.verify-btn');
            const btnText = document.getElementById('btn1Text');
            const code = input.value.trim();

            if (!code) {
                input.classList.add('text-error', 'shake');
                setTimeout(() => input.classList.remove('shake'), 500);
                return;
            }

            btn.disabled = true;
            btnText.innerHTML = '<span class="loader"></span> ...';

            try {
                const res = await fetch(`${API_BASE}/verify`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ code })
                });
                const data = await res.json();

                if (data.success && data.valid) {
                    currentCode = code;
                    document.getElementById('step1').classList.add('hidden');
                    document.getElementById('step2').classList.remove('hidden');
                    document.getElementById('step2').classList.add('fade-in');
                    
                    const previewCol = document.getElementById('previewColumn');
                    previewCol.classList.add('active'); 
                    setTimeout(() => {
                        previewCol.classList.add('visible');
                        updateRealTimeUI();
                    }, 50);
                    
                } else {
                    alert(data.message || "Invalid Code");
                    input.value = "";
                }
            } catch (e) {
                console.error(e);
                alert("Network Error");
            } finally {
                btn.disabled = false;
                btnText.innerText = i18n[currentUILang]['verify_btn'];
            }
        }

        // --- UI æ›´æ–°é€»è¾‘ (å®æ—¶) ---
        function selectType(type) {
            selectedType = type;
            document.querySelectorAll('.gift-option').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            updateRealTimeUI();
        }

        function updateRealTimeUI() {
            const to = document.getElementById('inputTo').value.trim();
            const from = document.getElementById('inputFrom').value.trim();
            
            // --- ä¿®æ”¹å¼€å§‹: å¤„ç†å¤šè¡Œæ–‡å­— ---
            let rawText = document.getElementById('inputCardText').value; // ä¸å»é™¤ä¸¤ç«¯ç©ºæ ¼ï¼Œä¿ç•™æ¢è¡Œä¹ æƒ¯
            let displayHtml = "";

            if (!rawText.trim()) {
                // å¦‚æœä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤æ–‡æ¡ˆ
                displayHtml = `â€œ ${i18n[currentCardLang]['default_card_text']} â€`;
            } else {
                // æŒ‰æ¢è¡Œç¬¦åˆ†å‰²ï¼Œå»é™¤ç©ºè¡Œï¼Œç„¶åç»™æ¯ä¸€è¡ŒåŠ å¼•å·
                const lines = rawText.split('\n').filter(line => line.trim() !== "");
                displayHtml = lines.map(line => `â€œ ${line.trim()} â€`).join('\n');
            }
            // --- ä¿®æ”¹ç»“æŸ ---

            // è·å–å½“å‰å¡ç‰‡è¯­è¨€çš„æ ‡ç­¾
            const langObj = i18n[currentCardLang];
            const labelTo = langObj['card_to'];
            const labelFrom = langObj['card_from'];
            const labelMinted = langObj['card_minted'];

            // æ›´æ–° DOM
            const elTo = document.getElementById('cardTo');
            const elFrom = document.getElementById('cardFrom');
            
            elTo.innerText = to ? `${labelTo}: ${to.toUpperCase()}` : `${labelTo}: -`;
            elFrom.innerText = from ? `${labelFrom}: ${from.toUpperCase()}` : `${labelFrom}: -`;
            
            // è¿™é‡Œç”¨ innerText èµ‹å€¼ï¼Œwhite-space: pre-wrap ä¼šå¤„ç†æ¢è¡Œ
            document.getElementById('cardTextDisplay').innerText = displayHtml;

            // åˆ·æ–°æ—¥æœŸ
            const dateStr = new Date().toISOString().split('T')[0].replace(/-/g, '.');
            document.getElementById('cardDate').innerText = `${labelMinted}: ${dateStr}`;

            // é‡ç»˜ Canvas
            const prevCanvas = document.getElementById('preview-canvas');
            if (prevCanvas.offsetWidth > 0) {
                 prevCanvas.width = prevCanvas.offsetWidth;
                 prevCanvas.height = prevCanvas.offsetHeight;
                 drawThemeEffect(prevCanvas, selectedType);
            }
        }

        // --- Step 2: æäº¤å¹¶ç”Ÿæˆ ---
        async function finalizeGift() {
            const toName = document.getElementById('inputTo').value.trim();
            const fromName = document.getElementById('inputFrom').value.trim();
            const wish = document.getElementById('inputWish').value.trim() || "Best Wishes";
            // å…¼å®¹ text æˆ– textareaï¼Œç›´æ¥å– value å³å¯
            const cardText = document.getElementById('inputCardText').value.trim() || i18n[currentCardLang]['default_card_text'];
            
            const btnText = document.getElementById('btn2Text');
            const btn = btnText.parentElement;

            btn.disabled = true;
            btnText.innerHTML = '<span class="loader"></span> ...';

            try {
                const payload = {
                    code: currentCode,
                    payload: { wish, to: toName, from: fromName }
                };

                const res = await fetch(`${API_BASE}/finalize`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();

                if (data.success) {
                    const encryptedCode = data.encryptedCode;
                    let targetBaseUrl = GIFT_URLS[selectedType];
                    const connector = targetBaseUrl.includes("?") ? "&" : "?";
                    const fullLink = `${targetBaseUrl}${connector}code=${encryptedCode}`;

                    // 1. åˆ‡æ¢ç•Œé¢
                    document.getElementById('step2').classList.add('hidden');
                    document.getElementById('result-area').classList.remove('hidden');
                    document.getElementById('result-area').classList.add('fade-in');
                    document.getElementById('finalLink').innerText = fullLink;

                    document.getElementById('cardId').innerText = `NO.${Math.floor(Math.random()*9000)+1000}`;
                    document.querySelector('.c-meta .highlight').innerText = i18n[currentUILang]['verified_text'];

                    // 2. æ¸²æŸ“äºŒç»´ç å’Œé«˜æ¸…å›¾
                    generateQRCodes(fullLink);
                    renderHDCard(toName, fromName, cardText, fullLink);

                    // 3. ã€æ–°å¢åŠŸèƒ½ã€‘è‡ªåŠ¨å¤åˆ¶é“¾æ¥ + æç¤º + è‡ªåŠ¨ä¸‹è½½
                    // ç­‰å¾…ä¸€å°ä¼šå„¿ç¡®ä¿DOMæ¸²æŸ“å®Œæˆ
                    setTimeout(async () => {
                        try {
                            // å°è¯•å†™å…¥å‰ªè´´æ¿
                            await navigator.clipboard.writeText(fullLink);
                            // å¼¹å‡ºæˆåŠŸæç¤º
                            alert(i18n[currentUILang]['alert_copy_done']);
                        } catch (err) {
                            console.error("Auto copy failed:", err);
                            // å¦‚æœå¤åˆ¶å¤±è´¥ï¼ˆæ¯”å¦‚æµè§ˆå™¨æƒé™æ‹¦æˆªï¼‰ï¼Œè‡³å°‘ä¸å½±å“ä¸‹è½½ï¼Œä¸å¼¹å¤åˆ¶æˆåŠŸçš„çª—ï¼Œç›´æ¥ä¸‹è½½
                        }

                        // è‡ªåŠ¨è§¦å‘ä¸‹è½½ (ç»™ alert ä¸€ä¸ªå…³é—­çš„æ—¶é—´ç¼“å†²)
                        downloadImage();
                    }, 500);

                } else {
                    alert("Error: " + data.message);
                }
            } catch (e) {
                console.error(e);
                alert("Error");
            } finally {
                btn.disabled = false;
                btnText.innerText = i18n[currentUILang]['btn_generate'];
            }
        }

        function generateQRCodes(url) {
            const qrOpts = {
                text: url,
                colorDark: "#D4AF37",
                colorLight: "#000000",
                correctLevel: QRCode.CorrectLevel.H
            };
            document.getElementById('qrcode').innerHTML = "";
            new QRCode(document.getElementById('qrcode'), { ...qrOpts, width: 50, height: 50 });
        }

        function renderHDCard(to, from, text, url) { 
            // 1. è®¾ç½®ç”»å¸ƒå°ºå¯¸åŒ¹é…æ–°çš„å®¹å™¨ (400px * 711px) 
            const hdCanvas = document.getElementById('hd-canvas'); 
            hdCanvas.width = 400; 
            hdCanvas.height = 711; 
            drawThemeEffect(hdCanvas, selectedType); 
 
            // 2. å¡«å……æ–‡å­— (ä½¿ç”¨é¢„è§ˆå›¾çš„é€»è¾‘ï¼Œä¸å†å¼ºåˆ¶å¤§å­—å·) 
            const langObj = i18n[currentCardLang]; 
            const elTo = document.getElementById('hd-cardTo'); 
            const elFrom = document.getElementById('hd-cardFrom'); 
            
            // å­—ä½“ç±»æ§åˆ¶ 
            const fontClass = currentCardLang === 'zh' ? 'font-serif' : 'font-mono'; 
            // è¿™é‡Œä¸ºäº†ç®€å•ï¼Œç›´æ¥å¤ç”¨æ ·å¼ï¼Œå¦‚æœéœ€è¦æ›´ç»†è‡´çš„å­—ä½“åˆ‡æ¢å¯ä»¥åŠ  class 
            
            elTo.innerText = to ? `${langObj.card_to}: ${to.toUpperCase()}` : ""; 
            elFrom.innerText = from ? `${langObj.card_from}: ${from.toUpperCase()}` : ""; 
            
            // ç›´æ¥å¤åˆ¶é¢„è§ˆåŒºå·²ç»å¤„ç†å¥½çš„å¸¦å¼•å·/æ¢è¡Œçš„æ–‡æœ¬ 
            document.getElementById('hd-cardWish').innerText = document.getElementById('cardTextDisplay').innerText; 
            
            const dateStr = new Date().toISOString().split('T')[0].replace(/-/g, '.'); 
            document.getElementById('hd-cardDate').innerText = `${langObj.card_minted}: ${dateStr}`; 
            document.getElementById('hd-cardId').innerText = document.getElementById('cardId').innerText; 
            
            // 3. ç”Ÿæˆé«˜æ¸…äºŒç»´ç  
            const qrOpts = { 
                text: url, 
                colorDark : "#D4AF37", 
                colorLight : "#000000", 
                correctLevel : QRCode.CorrectLevel.H 
            }; 
            document.getElementById('hd-qrcode').innerHTML = ""; 
            
            // ä¿®æ”¹ï¼šå®½åº¦è®¾ä¸º 70 (é…åˆå®¹å™¨çš„ 86px - 16px padding)ï¼Œä¿è¯å››å‘¨æœ‰ 8px çš„çº¯é»‘é™åŒº 
            new QRCode(document.getElementById('hd-qrcode'), { ...qrOpts, width: 70, height: 70 }); 
        }

        function drawPolygon(ctx, x, y, radius, sides, rotation) {
            ctx.beginPath();
            for (let i = 0; i < sides; i++) {
                const angle = (i * 2 * Math.PI / sides) - (Math.PI / 2) + rotation;
                const px = x + radius * Math.cos(angle);
                const py = y + radius * Math.sin(angle);
                if (i === 0) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
            }
            ctx.closePath();
            ctx.stroke();
        }

        function drawThemeEffect(canvas, type) {
            const ctx = canvas.getContext('2d');
            const w = canvas.width;
            const h = canvas.height;
            if (!w || !h) return;
            ctx.clearRect(0, 0, w, h);

            if (type === 'stars') {
                const bgGradient = ctx.createLinearGradient(0, 0, w, h);
                bgGradient.addColorStop(0, '#020205'); bgGradient.addColorStop(1, '#08080c');
                ctx.fillStyle = bgGradient; ctx.fillRect(0,0,w,h);
                const starCount = 300; 
                for (let i = 0; i < starCount; i++) {
                    const axis = Math.random();
                    let spread = (Math.random() - 0.5) * 2; 
                    spread = spread * spread * spread * (w * 0.35); 
                    const cx = axis * w; const cy = h - (axis * h);
                    const x = cx + spread; const y = cy + spread;
                    if(x < 0 || x > w || y < 0 || y > h) continue;
                    const size = Math.random() * 1.5 + 0.1; const alpha = Math.random() * 0.8 + 0.1;
                    ctx.beginPath(); ctx.arc(x, y, size, 0, Math.PI * 2);
                    ctx.fillStyle = (Math.abs(spread) < w * 0.1 && Math.random() > 0.5) ? `rgba(255, 220, 150, ${alpha})` : `rgba(255, 255, 255, ${alpha})`;
                    ctx.fill();
                }

            } else if (type === 'love') {
                ctx.fillStyle = '#150205'; ctx.fillRect(0,0,w,h);
                ctx.globalCompositeOperation = 'lighter'; 
                const layers = 6;
                for (let i = 0; i < layers; i++) {
                    ctx.beginPath();
                    const startY = h * 0.6 - (i * h * 0.05);
                    const cp1x = w * 0.3; const cp1y = startY - Math.random() * 150;
                    const cp2x = w * 0.7; const cp2y = startY + Math.random() * 150;
                    const endY = startY + Math.random() * 50;
                    ctx.moveTo(0, startY); ctx.bezierCurveTo(cp1x, cp1y, cp2x, cp2y, w, endY);
                    ctx.lineTo(w, h); ctx.lineTo(0, h); ctx.closePath();
                    const gradient = ctx.createLinearGradient(0, 0, w, h);
                    gradient.addColorStop(0, `hsla(${330 + i*10}, 80%, 20%, 0.05)`); 
                    gradient.addColorStop(0.5, `hsla(${350 + i*5}, 90%, 45%, 0.2)`); 
                    gradient.addColorStop(1, `hsla(${330}, 80%, 15%, 0.05)`);
                    ctx.fillStyle = gradient; ctx.fill();
                }
                ctx.globalCompositeOperation = 'source-over';
                const bottomFade = ctx.createLinearGradient(0, h * 0.6, 0, h);
                bottomFade.addColorStop(0, 'rgba(0, 0, 0, 0)'); bottomFade.addColorStop(0.7, 'rgba(5, 5, 5, 0.8)'); bottomFade.addColorStop(1, '#000000'); 
                ctx.fillStyle = bottomFade; ctx.fillRect(0, h*0.6, w, h*0.4);

            } else if (type === 'firework') {
                 ctx.fillStyle = '#020205'; ctx.fillRect(0,0,w,h);
                 ctx.globalCompositeOperation = 'lighter';
                 const fireworks = [{ x: w * 0.65, y: h * 0.28, baseHue: 40,  scale: 1.2 }, { x: w * 0.25, y: h * 0.45, baseHue: 190, scale: 0.9 }, { x: w * 0.75, y: h * 0.65, baseHue: 320, scale: 0.8 }];
                 fireworks.forEach(fw => {
                     const particleCount = 200; const maxRadius = w * 0.28 * fw.scale;
                     for (let i = 0; i < particleCount; i++) {
                         const angle = Math.random() * Math.PI * 2;
                         const speedFactor = Math.pow(Math.random(), 0.5); 
                         const currentRadius = maxRadius * speedFactor;
                         const gravityFactor = (Math.sin(angle) + 1) * 0.5;
                         let gravityDrop = 0;
                         if (maxRadius > 0) gravityDrop = (currentRadius / maxRadius) * (maxRadius * 0.35) * gravityFactor;
                         const endX = fw.x + Math.cos(angle) * currentRadius;
                         const endY = fw.y + Math.sin(angle) * currentRadius + gravityDrop;
                         const trailLen = currentRadius * 0.15; 
                         const prevRadius = currentRadius - trailLen;
                         const prevGravity = gravityDrop * 0.8;
                         const startX = fw.x + Math.cos(angle) * prevRadius;
                         const startY = fw.y + Math.sin(angle) * prevRadius + prevGravity;
                         let hue = fw.baseHue + (Math.random() - 0.5) * 60; 
                         if (Math.random() > 0.7) hue = Math.random() * 360; 
                         const fade = 1 - (currentRadius/maxRadius);
                         const opacity = 0.5 + fade * 0.5;
                         ctx.beginPath(); ctx.moveTo(startX, startY); ctx.lineTo(endX, endY);
                         ctx.lineWidth = Math.random() * 2 + 0.5; ctx.lineCap = 'round';
                         const gradient = ctx.createLinearGradient(startX, startY, endX, endY);
                         gradient.addColorStop(0, `hsla(${hue}, 100%, 50%, 0)`); gradient.addColorStop(1, `hsla(${hue}, 100%, 70%, ${opacity})`); 
                         ctx.strokeStyle = gradient; ctx.stroke();
                         ctx.beginPath(); ctx.arc(endX, endY, Math.random() * 1.5, 0, Math.PI*2);
                         ctx.fillStyle = `hsla(${hue}, 100%, 90%, 1)`; ctx.fill();
                     }
                 });
                 ctx.globalCompositeOperation = 'source-over';

            } else if (type === 'portal') {
                ctx.fillStyle = '#050100'; ctx.fillRect(0,0,w,h);
                const cx = w / 2; const cy = h / 2; const maxR = w * 0.4;
                ctx.globalCompositeOperation = 'lighter'; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
                
                ctx.shadowBlur = 50; ctx.shadowColor = "#FF4500"; ctx.strokeStyle = "rgba(255, 140, 0, 0.4)"; ctx.lineWidth = 4;
                ctx.beginPath(); ctx.arc(cx, cy, maxR, 0, Math.PI*2); ctx.stroke();
                ctx.shadowBlur = 15; ctx.shadowColor = "#FF8C00"; ctx.strokeStyle = "#FFD700"; ctx.lineWidth = 1.5;
                ctx.beginPath(); ctx.arc(cx, cy, maxR, 0, Math.PI*2); ctx.stroke();
                drawPolygon(ctx, cx, cy, maxR * 0.85, 6, Math.PI/6);
                drawPolygon(ctx, cx, cy, maxR * 0.7, 5, -Math.PI/10);
                drawPolygon(ctx, cx, cy, maxR * 0.55, 4, Math.PI/4);
                drawPolygon(ctx, cx, cy, maxR * 0.4, 3, Math.PI/2);
                ctx.beginPath(); ctx.arc(cx, cy, maxR * 0.2, 0, Math.PI*2); ctx.stroke();
                ctx.fillStyle = "#FFD700"; ctx.shadowBlur = 30; ctx.beginPath(); ctx.arc(cx, cy, 4, 0, Math.PI*2); ctx.fill();
                ctx.globalCompositeOperation = 'source-over';
            }
        }

        async function downloadImage() { 
            const hdCard = document.getElementById('hd-render-card'); 
            const btn = document.querySelector('.save-btn'); 
            const originalText = btn.innerText; 
            
            // ä¸´æ—¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€ 
            btn.innerText = "PROCESSING..."; 
            btn.disabled = true; 

            await document.fonts.ready; 
            await new Promise(r => setTimeout(r, 500)); // ç­‰å¾…å­—ä½“æ¸²æŸ“ 
            
            try { 
                // scale: 3 è¡¨ç¤ºç”Ÿæˆ 3 å€åˆ†è¾¨ç‡çš„å›¾ç‰‡ (400px * 3 = 1200px å®½) 
                // è¿™æ ·æ—¢ä¿è¯äº†æ’ç‰ˆåè°ƒï¼Œåˆä¿è¯äº†ä¿å­˜ä¸‹æ¥çš„å›¾ç‰‡è¶³å¤Ÿå¤§ã€è¶³å¤Ÿæ¸…æ™° 
                const canvas = await html2canvas(hdCard, { 
                    scale: 3, 
                    backgroundColor: "#000", 
                    useCORS: true 
                }); 
                
                const link = document.createElement('a'); 
                link.download = `CyberCard_2026_${selectedType}.png`; 
                link.href = canvas.toDataURL("image/png"); 
                link.click(); 
            } catch (err) { 
                console.error(err); 
                alert("Download Error"); 
            } finally { 
                btn.innerText = originalText; 
                btn.disabled = false; 
            } 
        }
        
        window.addEventListener('resize', () => {
             if(document.getElementById('previewColumn').classList.contains('active')) {
                 updateRealTimeUI();
             }
        });
    </script>
</body>
</html>